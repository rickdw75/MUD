<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arcadia: A Tiny 2D Rescue</title>
<style>
  :root {
    /* Brighter palette so tiles aren't lost against the bg */
    --bg:#0f1116; --fg:#eef1f7; --muted:#aab3c5; --accent:#7bd389; --accent2:#7aa2f7; --ui:#1a1f2b; --ui2:#22283a;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family: ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  #wrap{max-width:980px;margin:0 auto;padding:12px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  header h1{font-size:18px;font-weight:700;margin:0;letter-spacing:.3px}
  header .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:var(--ui2);color:var(--muted)}
  #gamebox{display:grid;grid-template-columns:fit-content(100%) 1fr;gap:12px}
  canvas{image-rendering: pixelated;image-rendering: crisp-edges;border:1px solid #333a4f;background:#101319}
  #hud{display:flex;gap:10px;align-items:center;background:var(--ui);padding:8px 10px;border-radius:8px}
  #hud span{font-size:13px;color:var(--muted)}
  #hud .badge{background:var(--ui2);padding:2px 6px;border-radius:5px;color:var(--fg)}
  #sidebar{display:flex;flex-direction:column;gap:12px}
  #panel{background:var(--ui);border:1px solid #2a3247;border-radius:8px;padding:10px}
  #panel h3{margin:0 0 6px 0;font-size:14px;color:var(--muted)}
  #log{height:180px;overflow:auto;font-size:13px;line-height:1.3;background:var(--ui2);border-radius:6px;padding:8px}
  #btns{display:flex;flex-wrap:wrap;gap:8px}
  button{background:#2a3146;color:var(--fg);border:1px solid #3a4566;border-radius:6px;padding:7px 10px;font-size:13px;cursor:pointer}
  button:hover{filter:brightness(1.1)}
  #controls{display:grid;grid-template-columns:repeat(3,48px);gap:6px;justify-content:center;align-items:center}
  .pad{width:48px;height:48px;display:flex;justify-content:center;align-items:center;background:#2a3146;border:1px solid #3a4566;border-radius:6px;user-select:none}
  .pad:active{filter:brightness(1.2)}
  .wide{grid-column:1/-1}
  #credits{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}
  #toast{position:fixed;inset:auto 0 12px 0;display:flex;justify-content:center;pointer-events:none}
  #toast span{pointer-events:auto;background:#1f2a1f;border:1px solid #294129;color:#bde5bd;padding:8px 12px;border-radius:6px;font-size:13px;display:none}
  #toast span.show{display:inline-block}

  /* Title overlay */
  #title{position:fixed;inset:0;background:rgba(10,12,18,.92);display:flex;align-items:center;justify-content:center;z-index:10}
  #title .box{background:#101623;border:1px solid #2c3858;border-radius:10px;padding:22px;max-width:520px;text-align:center}
  #title h2{margin:0 0 8px 0}
  #title p{margin:8px 0;color:var(--muted)}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>Arcadia: A Tiny 2D Rescue</h1>
    <span class="pill">Top-Down • Single Session • Multiple Endings</span>
  </header>

  <div id="hud">
    <span>HP: <span id="hp" class="badge">5</span></span>
    <span>ATK: <span id="atk" class="badge">1</span></span>
    <span>Keys: <span id="keys" class="badge">0</span></span>
    <span>Inv: <span id="inv" class="badge">—</span></span>
    <span>Zone: <span id="zone" class="badge">Start</span></span>
  </div>

  <div id="gamebox">
    <canvas id="c" width="640" height="384" aria-label="Game canvas"></canvas>

    <div id="sidebar">
      <div id="panel">
        <h3>Actions</h3>
        <div id="btns">
          <button id="bTalk">Talk</button>
          <button id="bUse">Use</button>
          <button id="bSave">Save</button>
          <button id="bLoad">Load</button>
          <button id="bHelp">Help</button>
          <button id="bReset">Reset</button>
        </div>
        <h3 style="margin-top:10px">Log</h3>
        <div id="log" aria-live="polite"></div>
      </div>

      <div id="panel">
        <h3>Mobile Controls</h3>
        <div id="controls">
          <div></div>
          <div class="pad" data-dx="0" data-dy="-1">↑</div>
          <div></div>
          <div class="pad" data-dx="-1" data-dy="0">←</div>
          <div class="pad" data-dx="0" data-dy="0" id="padAct">●</div>
          <div class="pad" data-dx="1" data-dy="0">→</div>
          <div></div>
          <div class="pad" data-dx="0" data-dy="1">↓</div>
          <div></div>
          <div class="pad wide" id="padRun">Run</div>
        </div>
        <div id="credits">Move: WASD/Arrows • Run: Shift • Talk/Use: Space/Enter</div>
      </div>
    </div>
  </div>
</div>
<div id="toast"><span id="toastMsg"></span></div>

<!-- Title -->
<div id="title">
  <div class="box">
    <h2>Arcadia: A Tiny 2D Rescue</h2>
    <p>Find the Princess. Decide what “rescue” means.</p>
    <p>Controls: Arrows/WASD to move, Shift to run, Space/Enter to talk/use.</p>
    <button id="startBtn">Start Game</button>
    <p style="margin-top:10px;font-size:12px">This is a single-file game. Your progress saves in the browser.</p>
  </div>
</div>

<script>
/* ------------------------------------------
  Arcadia 2D — patched build
  - Brighter tiles
  - Guaranteed initial render
  - Title overlay (press Start)
-------------------------------------------*/

const TILE=16, SCALE=2, VIEW_W=20, VIEW_H=12;
const CANVAS_W=TILE*VIEW_W*SCALE, CANVAS_H=TILE*VIEW_H*SCALE;

// Tiles
const T={EMPTY:0,WALL:1,GRASS:2,WATER:3,DOOR:4,LOCK:5,DARK:6,CHASM:7,TORCH:8,NPC:9,CHEST:10,ALTAR:11,EXIT:12,ENEMY:13,SIGN:14,STONE:15};

// Items
const IT={ROPE:'Rope',LIGHT:'Lantern',TRUTH:'Truth Rune',KEY:'Key'};

// Zones (same structure; brighter look handled in renderer)
const ZONES={ /* --- START --- */ 
Start:{music:'calm',hint:'A quiet grove. A trail north leads to the ridge.',
grid:[
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,2,14,2,2,2,2,2,2,2,2,1],
[1,2,2,2,2,9,2,2,2,2,2,2,2,2,2,2,10,2,2,1],
[1,2,2,2,2,2,2,2,1,1,1,2,2,2,2,2,1,1,2,1],
[1,2,2,2,2,2,2,2,1,3,1,2,2,2,2,2,1,3,2,1],
[1,2,2,2,2,2,2,2,1,3,1,2,2,2,2,2,1,3,2,1],
[1,2,2,2,2,2,2,2,1,1,1,2,2,2,2,2,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,8,2,2,2,2,2,2,1],
[1,2,2,2,2,2,2,2,2,4,2,2,2,2,2,2,2,2,12,1],
[1,2,2,2,2,2,2,2,2,5,2,2,2,2,2,2,2,2,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
],
actors:[
  {type:'npc',id:'guide',x:5,y:2,text:[
   "You woke in the grove as if summoned by the land.",
   "North is the ridge. East, a trader. West holds a relic.",
   "If you seek the Princess, bring light to where light was stolen."
  ]},
  {type:'sign',x:10,y:1,text:["Trail to Ridge ↑","Trader →","Relic ←"]},
  {type:'chest',x:16,y:2,item:IT.KEY,text:["You found a small brass key."]}
],
exits:[{x:18,y:8,to:'Ridge',tx:1,ty:8}],
locks:[{x:9,y:9,needs:'key',openTo:T.DOOR,text:"A locked gate. A simple key should do."}]
},
/* Trader */ Trader:{alias:'East Hollow',music:'calm',hint:'A friendly trader under a lantern-lit awning.',
grid:(()=>{const g=Array.from({length:12},(_,y)=>Array.from({length:20},(_,x)=>(y==0||y==11||x==0||x==19)?1:2));g[6][10]=9;g[5][10]=8;g[10][18]=12;g[1][1]=14;return g;})(),
actors:[
 {type:'npc',id:'trader',x:10,y:6,text:[
  "You look underprepared. I trade goods for stories.",
  "No? Then take this rope. I’m tired of tripping over it."
 ],give:IT.ROPE},
 {type:'sign',x:1,y:1,text:["East Hollow — mind your pockets."]}
],
exits:[{x:18,y:10,to:'Start',tx:17,ty:8}]},
/* Relic */ Relic:{alias:'Old Stones',music:'calm',hint:'Weathered stones. Something hums beneath.',
grid:(()=>{const g=Array.from({length:12},(_,y)=>Array.from({length:20},(_,x)=>(y==0||y==11||x==0||x==19)?1:2));g[6][10]=11;g[10][18]=12;g[2][2]=14;return g;})(),
actors:[
 {type:'sign',x:2,y:2,text:["Old Stones — do not whisper your name here."]},
 {type:'altar',x:10,y:6,item:IT.TRUTH,text:[
  "You place your hand upon the altar.",
  "A cold idea settles in your mind: truth is a lockpick for lies."
 ]}
],
exits:[{x:18,y:10,to:'Start',tx:16,ty:8}]},
/* Ridge */ Ridge:{music:'tense',hint:'Windy crest. A chasm splits the path.',
grid:(()=>{const g=Array.from({length:12},(_,y)=>Array.from({length:20},(_,x)=>(y==0||y==11||x==0||x==19)?1:2));for(let x=6;x<14;x++)g[6][x]=7;g[10][18]=12;g[5][10]=4;g[4][10]=6;g[3][10]=6;g[2][3]=14;g[8][8]=13;g[8][11]=13;return g;})(),
actors:[
 {type:'sign',x:3,y:2,text:["Mind the gap. Rope helps. Lantern helps more."]},
 {type:'npc',id:'hermit',x:2,y:9,text:[
  "The Princess? Not where you think.","Shadows moved long before she vanished. Bring light."
 ]}
],
exits:[
 {x:18,y:10,to:'Start',tx:18,ty:8},
 {x:10,y:4,to:'Halls',tx:10,ty:10,needs:IT.LIGHT,fail:"It’s too dark to proceed safely."}
],
chasm:{y:6,x1:6,x2:13,needs:IT.ROPE,fail:"A sheer drop. A rope would make this trivial."}
},
/* Halls */ Halls:{music:'tense',hint:'Dust and echoes. Two wings: lore and arms.',
grid:(()=>{const g=Array.from({length:12},(_,y)=>Array.from({length:20},(_,x)=>(y==0||y==11||x==0||x==19)?1:2));g[10][1]=12;g[6][10]=5;g[2][3]=14;g[5][4]=4;g[5][15]=4;g[7][6]=13;g[8][13]=13;return g;})(),
actors:[{type:'sign',x:3,y:2,text:["Left: Lore. Right: Arsenal. Center: Sealed truth."]}],
exits:[{x:1,y:10,to:'Ridge',tx:10,ty:5}],
doors:[{x:4,y:5,to:'Lore',tx:10,ty:10},{x:15,y:5,to:'Arsenal',tx:10,ty:10}],
seal:{x:10,y:6,needs:IT.TRUTH,text:"The mechanism judges not strength but honesty.",opensTo:'Inner'}
},
/* Lore */ Lore:{music:'calm',hint:'Whispering shelves, a lantern left burning.',
grid:(()=>{const g=Array.from({length:12},(_,y)=>Array.from({length:20},(_,x)=>(y==0||y==11||x==0||x==19)?1:2));g[10][1]=12;g[5][10]=8;g[2][2]=14;return g;})(),
actors:[{type:'sign',x:2,y:2,text:["Leave what you borrow, borrow what you leave."]},{type:'torch',x:10,y:5,item:IT.LIGHT,text:["You take the lantern. Its flame is steady but not warm."]}],
exits:[{x:1,y:10,to:'Halls',tx:4,ty:6}]},
/* Arsenal */ Arsenal:{music:'calm',hint:'Training dummies and a glinting blade.',
grid:(()=>{const g=Array.from({length:12},(_,y)=>Array.from({length:20},(_,x)=>(y==0||y==11||x==0||x==19)?1:2));g[10][1]=12;g[6][10]=10;g[2][2]=14;return g;})(),
actors:[{type:'sign',x:2,y:2,text:["Take only what you can carry into your conscience."]},{type:'chest',x:10,y:6,item:'Blade',text:["You found a tempered blade. ATK +1."]}],
exits:[{x:1,y:10,to:'Halls',tx:15,ty:6}]},
/* Inner */ Inner:{music:'boss',hint:'A quiet chamber. Too quiet.',
grid:(()=>{const g=Array.from({length:12},(_,y)=>Array.from({length:20},(_,x)=>(y==0||y==11||x==0||x==19)?1:6));for(let y=2;y<10;y++)for(let x=2;x<18;x++)g[y][x]=2;g[10][10]=12;g[6][10]=9;g[5][10]=13;return g;})(),
actors:[{type:'npc',id:'princess',x:10,y:6,text:["You came. The land said you would.","Take me away from here. Please."]}],
exits:[{x:10,y:10,to:'Halls',tx:10,ty:6}]}
};

// RNG
let seed=Math.floor(Math.random()*1e9);
function rnd(){ seed^=seed<<13; seed^=seed>>>17; seed^=seed<<5; return (seed>>>0)/4294967296; }

// State
const state={zone:'Start',px:2,py:8,hp:5,atk:1,keys:0,inv:{},doom:0,withPrincess:false,ended:false};

// Canvas
const c=document.getElementById('c'); c.width=CANVAS_W; c.height=CANVAS_H;
const ctx=c.getContext('2d');

// BRIGHTER tile renderer
function drawTile(x,y,t){
  const col={
    [T.EMPTY]:'#0c0f14',
    [T.WALL]:'#475066',
    [T.GRASS]:'#2e7c45',
    [T.WATER]:'#2171b3',
    [T.DOOR]:'#8c6a3d',
    [T.LOCK]:'#8a8fb8',
    [T.DARK]:'#09101c',
    [T.CHASM]:'#17181d',
    [T.TORCH]:'#d8a648',
    [T.NPC]:'#314964',
    [T.CHEST]:'#7a5a3a',
    [T.ALTAR]:'#3a7492',
    [T.EXIT]:'#39507c',
    [T.ENEMY]:'#7d3a55',
    [T.SIGN]:'#536a3a',
    [T.STONE]:'#556080'
  }[t] || '#222';
  rect(x,y,col);
  // readable details
  if(t===T.GRASS){ pixel(x+3,y+3,'#3b9a57'); pixel(x+12,y+10,'#3b9a57'); }
  if(t===T.WALL){ pixel(x+6,y+6,'#5b6781'); pixel(x+10,y+9,'#5b6781'); }
  if(t===T.WATER){ pixel(x+4,y+4,'#2b8bd9'); pixel(x+11,y+7,'#2b8bd9'); }
  if(t===T.CHASM){ pixel(x+8,y+8,'#0a0b0e'); pixel(x+6,y+10,'#0a0b0e'); }
  if(t===T.DOOR){ rect(x+6,y+2,'#6d532f'); pixel(x+9,y+8,'#e0c06a'); }
  if(t===T.LOCK){ rect(x+5,y+6,'#9aa0cf'); pixel(x+9,y+8,'#e0c06a'); }
  if(t===T.TORCH){ rect(x+6,y+4,'#7a5d2c'); pixel(x+8,y+5, ['#ffd27a','#ffc04d','#ffe0a6','#ffb347'][(rnd()*4)|0]); }
  if(t===T.SIGN){ rect(x+6,y+6,'#7e6a46'); pixel(x+7,y+5,'#e7d8a7'); }
}

function pixel(tx,ty,color){ ctx.fillStyle=color; ctx.fillRect(tx*TILE*SCALE,ty*TILE*SCALE,SCALE,SCALE); }
function rect(tx,ty,color){ ctx.fillStyle=color; ctx.fillRect(tx*TILE*SCALE,ty*TILE*SCALE,TILE*SCALE,TILE*SCALE); }

function drawPlayer(x,y){ rect(x,y,'#c5eb98'); pixel(x+7,y+3,'#3a3a47'); pixel(x+7,y+8,'#7aa2f7'); }
function drawPrincess(x,y){ rect(x,y,'#f0b3d0'); pixel(x+7,y+3,'#f3e5b5'); }

// HUD helpers
function h(id){return document.getElementById(id);}
function drawHUD(){
  h('hp').textContent=state.hp; h('atk').textContent=state.atk;
  h('keys').textContent=state.keys;
  const inv = Object.keys(state.inv).filter(k=>state.inv[k]);
  h('inv').textContent = inv.length? inv.join(', ') : '—';
  h('zone').textContent = state.zone;
}

// Map helpers
function currentZone(){return ZONES[state.zone];}
function isSolid(t){ return t===T.WALL || t===T.STONE || t===T.LOCK; }

function log(...lines){
  const box=h('log');
  for(const line of lines){ const p=document.createElement('div'); p.textContent=line; box.appendChild(p); }
  box.scrollTop = box.scrollHeight;
}
function toast(msg,ms=1600){ const t=h('toastMsg'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms); }

// Input
const keys={};
document.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
  if(e.key===' '||e.key==='Enter') act();
});
document.addEventListener('keyup',e=>{ keys[e.key.toLowerCase()]=false; });
document.getElementById('bTalk').onclick=()=>talk();
document.getElementById('bUse').onclick =()=>act();
document.getElementById('bSave').onclick=()=>saveGame();
document.getElementById('bLoad').onclick=()=>loadGame(true);
document.getElementById('bHelp').onclick=()=>help();
document.getElementById('bReset').onclick=()=>resetGame();
for(const el of document.querySelectorAll('.pad')){
  el.addEventListener('click',()=>{
    const dx=+el.dataset.dx, dy=+el.dataset.dy;
    if(el.id==='padRun'){ keys['shift']=true; setTimeout(()=>keys['shift']=false,250); return; }
    if(el.id==='padAct'){ act(); return; }
    move(dx,dy);
  });
}

// Loop
let running=false;
let last=0;
function loop(ts){
  if(!running) return;
  const dt=(ts-last)/16.7; last=ts;
  update(dt); render();
  requestAnimationFrame(loop);
}
function startGame(){
  if(running) return;
  document.getElementById('title').style.display='none';
  running=true; last=performance.now(); render(); requestAnimationFrame(loop);
}

// Update / Move
function update(){
  let dx=0,dy=0;
  if(keys['arrowup']||keys['w']) dy=-1;
  if(keys['arrowdown']||keys['s']) dy=1;
  if(keys['arrowleft']||keys['a']) dx=-1;
  if(keys['arrowright']||keys['d']) dx=1;
  if(dx||dy) move(dx,dy, keys['shift']||keys['shiftleft']);
}
function move(dx,dy){
  const z=currentZone();
  const nx=Math.max(1,Math.min(18,state.px+dx));
  const ny=Math.max(1,Math.min(10,state.py+dy));
  const tile=z.grid[ny][nx];
  if(isSolid(tile)) return;

  // chasm
  if(tile===T.CHASM && !state.inv[IT.ROPE]){ toast("A deadly drop."); return; }
  // dark
  if(tile===T.DARK && !state.inv[IT.LIGHT]){ toast("Too dark to step safely."); return; }

  state.px=nx; state.py=ny;

  // exits
  const ex=(z.exits||[]).find(e=>e.x===state.px && e.y===state.py);
  if(ex){
    if(ex.needs && !state.inv[ex.needs]){ toast(ex.fail||"It won't let you pass."); return; }
    goZone(ex.to,ex.tx,ex.ty); return;
  }

  // Halls doors + seal
  if(state.zone==='Halls'){
    const d=(ZONES.Halls.doors||[]).find(e=>e.x===state.px && e.y===state.py);
    if(d){ goZone(d.to,d.tx,d.ty); return; }
    const s=ZONES.Halls.seal;
    if(state.px===s.x && state.py===s.y){
      if(state.inv[IT.TRUTH]){
        log("The seal yields to your conviction.");
        ZONES.Halls.grid[s.y][s.x]=T.DOOR;
        ZONES.Halls.doors.push({x:s.x,y:s.y,to:s.opensTo,tx:10,ty:10});
      } else toast(s.text);
    }
  }

  // Random tiny encounters
  if(['Ridge','Halls','Inner'].includes(state.zone) && Math.random()<0.06){
    combat({hp:2,atk:1});
  }
}

// Actions
function act(){
  const z=currentZone();
  // underfoot interactions
  const t=z.grid[state.py][state.px];
  if(t===T.CHEST) return openChest();
  if(t===T.TORCH) return takeTorch();
  if(t===T.ALTAR) return touchAltar();

  // nearby talk/sign
  const adj=[{x:state.px+1,y:state.py},{x:state.px-1,y:state.py},{x:state.px,y:state.py+1},{x:state.px,y:state.py-1}];
  const npc=(z.actors||[]).find(a=>a.type==='npc' && adj.some(p=>p.x===a.x && p.y===a.y));
  if(npc) return talk(npc.x,npc.y);
  const sign=(z.actors||[]).find(a=>a.type==='sign' && adj.some(p=>p.x===a.x && p.y===a.y));
  if(sign) return readSign(sign.x,sign.y);

  toast("Nothing to do.");
}
function talk(x,y){
  const z=currentZone();
  const npc=(z.actors||[]).find(a=>a.type==='npc' && a.x===x && a.y===y)
      || (z.actors||[]).find(a=>a.type==='npc' && Math.abs(a.x-state.px)+Math.abs(a.y-state.py)<=1);
  if(!npc){ toast("You mutter to yourself."); return; }

  if(npc.id==='trader' && !state.inv[IT.ROPE]){
    state.inv[IT.ROPE]=true; log("Trader:","“Take the rope. The ridge eats the careless.”"); toast("Got: Rope"); drawHUD(); return;
  }
  if(npc.id==='guide' || npc.id==='hermit'){ npc.text.forEach(s=>log(s)); return; }
  if(state.zone==='Inner' && npc.id==='princess'){
    if(!state.withPrincess){
      state.withPrincess=true; log("Princess:","“Let’s go. Quickly.”"); toast("She follows.");
      // remove lurking enemy if you carry TRUTH
      if(state.inv[IT.TRUTH]) ZONES.Inner.grid[5][10]=T.GRASS;
    } else log("Princess:","“Why do you hesitate?”");
  }
}
function readSign(x,y){ const s=(currentZone().actors||[]).find(a=>a.type==='sign' && a.x===x && a.y===y); if(s) s.text.forEach(t=>log(t)); }
function openChest(){ const z=currentZone(); const a=(z.actors||[]).find(e=>e.type==='chest' && e.x===state.px && e.y===state.py); if(!a) return; if(a.item===IT.KEY){state.keys++;toast("Got: Key");} else if(a.item==='Blade'){state.atk=Math.max(state.atk,2);toast("ATK +1");} z.grid[state.py][state.px]=T.GRASS; drawHUD(); }
function takeTorch(){ const z=currentZone(); if(!state.inv[IT.LIGHT]){state.inv[IT.LIGHT]=true;toast("Got: Lantern");} z.grid[state.py][state.px]=T.GRASS; drawHUD(); }
function touchAltar(){ const z=currentZone(); if(!state.inv[IT.TRUTH]){state.inv[IT.TRUTH]=true; log("You place your hand upon the altar.","A cold idea settles in your mind: truth is a lockpick for lies."); toast("Got: Truth Rune"); drawHUD(); } else toast("The altar is quiet."); }

function combat(e){ log("A shadow rushes you!"); if(Math.random()<0.5){ log("You strike first.","It reels."); } else { state.hp-=1; log("It strikes first!","You take 1."); if(state.hp<=0){ gameOver(); return; } } if(Math.random()<0.12){ state.keys++; toast("Found: Key"); } drawHUD(); }
function gameOver(){ if(state.ended) return; state.ended=true; log("You fall. The land exhales. Your story ends here."); toast("Game Over"); }

// Zone change
function goZone(name,tx,ty){
  state.zone=name; state.px=tx; state.py=ty;
  const z=currentZone();
  log(`→ ${name}${z.alias? ' ('+z.alias+')':''}.`, z.hint||"");
  drawHUD();
  // wire Start side exits (once)
  if(name==='Start' && !(ZONES.Start._wired)){ ZONES.Start._wired=true; ZONES.Start.exits.push({x:9,y:8,to:'Trader',tx:2,ty:10}); ZONES.Start.exits.push({x:3,y:8,to:'Relic',tx:2,ty:10}); }
}

// Render (full 20×12 view; always draws immediately)
function render(){
  ctx.fillStyle='#0b0e14'; ctx.fillRect(0,0,CANVAS_W,CANVAS_H);
  const z=currentZone();
  for(let y=0;y<VIEW_H;y++){
    for(let x=0;x<VIEW_W;x++){
      const t = (z.grid[y] && z.grid[y][x] !== undefined) ? z.grid[y][x] : T.WALL;
      drawTile(x,y,t);
    }
  }
  // actors
  for(const a of (z.actors||[])){ if(a.type==='npc'){ drawNPC(a.x,a.y); } }
  if(z===ZONES.Inner){ drawPrincess(10,6); }
  drawPlayer(state.px,state.py);
  if(state.withPrincess){ drawPrincess(Math.max(1, state.px-1), state.py); }
}
function drawNPC(x,y){ rect(x,y,'#3a5676'); pixel(x+7,y+6,'#e8edf6'); }

// Save/Load
const SAVE_KEY='arcadia2d_save';
function saveGame(){ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); toast("Saved"); }
function loadGame(announce){ const s=localStorage.getItem(SAVE_KEY); if(!s){ if(announce) toast("No save found"); return; } Object.assign(state, JSON.parse(s)); toast("Loaded"); drawHUD(); render(); }
function resetGame(){ localStorage.removeItem(SAVE_KEY); Object.assign(state,{zone:'Start',px:2,py:8,hp:5,atk:1,keys:0,inv:{},doom:0,withPrincess:false,ended:false}); log("New journey begins."); drawHUD(); render(); }

// Help + init
function help(){ log("Controls: Arrows/WASD move, Shift runs. Space/Enter talk/use.","Goal: Find and rescue the Princess.","Hints: Rope crosses chasms. Lantern pierces darkness. Truth opens seals.","Save/Load uses your browser storage."); }
function init(){ drawHUD(); render(); log("Press Start when ready."); }
init();

// Title start
document.getElementById('startBtn').addEventListener('click',startGame);
document.addEventListener('keydown',e=>{ if(!running) startGame(); },{once:true});
</script>
</body>
</html>
